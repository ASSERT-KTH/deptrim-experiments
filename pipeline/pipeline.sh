#!/bin/bash
# ============================================================
# This script is used to run the pipeline on a single project.
# ============================================================

# Input arguments
REPO_NAME=$1;
GITHUB_URL=$2;
MODULE_DIR=$3;
RELEASE=$4;
COMMIT=$5;

# Variables
PROJECTS_DIR="projects"
RESULTS_DIR="results"
logger_deptrim="[DEPTRIM]"
logger_maven="[MAVEN]"
logger_pipeline="[PIPELINE]"
CURRENT_DIR=$(pwd)

# Clone the repo from URL
echo "${logger_pipeline} Cloning $REPO_NAME"
cd $PROJECTS_DIR
git clone "$GITHUB_URL"

# CD into the project directory
echo "${logger_pipeline} CDing into $REPO_NAME"
cd "$REPO_NAME"

# Checkout the release
echo "${logger_pipeline} Checking out $RELEASE with commit $COMMIT"
git checkout "$COMMIT"

# CD into the module if any
echo "${logger_pipeline} CDing into $MODULE_DIR"
cd "$MODULE_DIR"

# Run the pipeline from module directory if any
mkdir original
cp pom.xml pom-original.xml
echo "${logger_deptrim} Building original project and storing data"
cp pom.xml original/pom-original.xml
mvn clean package >> original/maven.log
cp target/*.jar original/
mvn dependency:copy-dependencies -DincludeScope=runtime >> original/compile-scope-dependencies.log
mkdir original/compile-scope-dependencies/
cp -r target/dependency original/compile-scope-dependencies/
mvn dependency:copy-dependencies >> original/all-dependencies.log
mkdir original/all-dependencies/
cp -r target/dependency original/all-dependencies/
mvn dependency:tree >> original/dependency-tree.log

# RUN DEPTRIM
mkdir deptrim
echo "====================================================="
echo "${logger_deptrim} Running DepTrim"
echo "====================================================="
mvn se.kth.castor:deptrim-maven-plugin:0.0.1:deptrim -DcreateAllPomSpecialized=true -DverboseMode=true -DignoreScopes=test,provided,system,import,runtime >> deptrim/deptrim.log
cp -r libs-deptrim deptrim

# EXECUTING POMS
poms=`find . -name "pom-specialized*.xml"`
echo "${logger_deptrim} Number of poms generated by DepTrim:"
echo "${poms}"

for i in ${poms}
do
  length=${#i}
  cut_length=$((length-4))
  specialized_pom=`echo ${i} | cut -c 3-`
  # create a folder for the specialized pom
  output=`echo ${i} | cut -c 3-${cut_length}`
  mkdir ${output}
  cp ${specialized_pom} ${output}/
  # Setting as main pom
  mv ${specialized_pom} pom.xml
  # Running mvn clean package
  echo "====================================================="
  echo "${logger_maven} Building with ${specialized_pom}"
  echo "====================================================="
  mvn clean package >> ${output}/maven.log
  mvn dependency:tree >> ${output}/dependency-tree.log
  cp target/*.jar ${output}/
  # Restoring pom number
  mv pom.xml ${specialized_pom}
done

# Restore original pom
echo "${logger_pipeline}  Restoring original pom and exiting"
mv pom-original.xml pom.xml

# Copy the results to the results directory
echo "${logger_pipeline}  Copying the results to the results directory"
cp -r . ../../../"$RESULTS_DIR"/"$MODULE_DIR"

exit 0